<!doctype html><html class=no-js lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Kafka必知必会 - 神秘极客</title><script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script><meta name=description content><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class=container><div class=logo><a class=logo__link href=/ title=神秘极客 rel=home><div class=logo__title>神秘极客</div><div class=logo__tagline>学习编程之美</div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>菜单</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/archives/><i class="fa fa-road"></i><span class=menu__text>学编程</span></a></li><li class=menu__item><a class=menu__link href=/about/><i class="fa fa-heart"></i><span class=menu__text>关于我</span></a></li><li class=menu__item><a class=menu__link href=/donate/><i class="fa fa-heart"></i><span class=menu__text>捐赠</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Kafka必知必会</h1></header><div class="post__toc toc"><div class=toc__title>目录</div><div class=toc__menu><nav id=TableOfContents><ul><li><ul><li><a href=#什么是kafka>什么是Kafka</a></li><li><a href=#为什么kafka会这么快>为什么Kafka会这么快</a></li><li><a href=#参考链接>参考链接</a></li></ul></li></ul></nav></div></div><div class="content post__content clearfix"><h3 id=什么是kafka>什么是Kafka</h3><p>Kafka是一个分布式流处理平台。一个流平台有这三个关键功能：</p><ol><li>发布和订阅记录流，类似一个消息队列或者企业消息系统。</li><li>能够以较强的容错性存储流记录。</li><li>能够及时处理流记录。</li></ol><h4 id=应用场景>应用场景</h4><p>Kafka通常用于两类广泛的应用：</p><ol><li>构建实时流数据管道，让系统之间或应用之间可靠的获取数据</li><li>构建能够改变或响应流数据的实时流应用</li></ol><h4 id=实现原理>实现原理</h4><p>为了理解Kafka如何实现这些，我们会从下往上研究Kafka的功能。</p><ol><li>Kafka作为一个集群运行在一个或者多个可跨数据中心的服务器上。</li><li>Kafka集群以分类的形式存储流记录，称之为主题(topics)。</li><li>每一条记录包含键(key)，值(value)，时间戳(timestamp)。</li></ol><p>在Kafka中，客户端和服务器之间通信通过简单，高性能，语言无关的TCP协议实现。该协议自带版本标识，默认向后兼容旧版本协议。官方提供Java的客户端，其他语言由第三方提供。</p><h4 id=相关名词>相关名词</h4><h4 id=生产者producers>生产者(Producers)</h4><p>所谓生产者，就是产生消息的服务，它们可以选择发布消息到指定主题。生产者负责选择指定的记录发布到指定主题的指定分区，负载均衡算法有轮询以及根据记录关键字分区。</p><h4 id=消费者consumers>消费者(Consumers)</h4><p>所谓的消费者是指，消费kafka消息的服务，通常是各种客户端。</p><p>每个消费者使用消费组标识自己(consumer group name)。当消费组里只有一个实例时，当前的消费者消费全部分区的消息。Kafka是通过分区来实现扩展性和容错性。</p><p>假设Kafka集群有2个Server(Server1 Server2)，4个分区(P0 P1 P2 P3)，2个消费组(Consumer Group A Consumer Group B)，每个消费组分别有2个和4个消费者(C1 — C6)。见下图：</p><p><img src=https://kafka.apache.org/21/images/consumer-groups.png alt=img></p><p>那么整体消费可能情况如下表：</p><table><thead><tr><th align=left>消费者/分区</th><th align=left>Server1(P0)</th><th align=left>Server1(P3)</th><th align=left>Server2(P1)</th><th align=left>Server2(P2)</th></tr></thead><tbody><tr><td align=left>C1</td><td align=left>✓</td><td align=left>✓</td><td align=left>—</td><td align=left>—</td></tr><tr><td align=left>C2</td><td align=left>—</td><td align=left>—</td><td align=left>✓</td><td align=left>✓</td></tr><tr><td align=left>C3</td><td align=left>✓</td><td align=left>—</td><td align=left>—</td><td align=left>—</td></tr><tr><td align=left>C4</td><td align=left>—</td><td align=left>✓</td><td align=left>—</td><td align=left>—</td></tr><tr><td align=left>C5</td><td align=left>—</td><td align=left>—</td><td align=left>✓</td><td align=left>—</td></tr><tr><td align=left>C6</td><td align=left>—</td><td align=left>—</td><td align=left>—</td><td align=left>✓</td></tr></tbody></table><p>Kafka实现消费的方式是尽可能的平均分配相关分区，每个分区都只拥有一个消费者。消费者的添加和删除会动态的改变分区的分配，分区会动态分配到其他消费者。</p><p>Kafka只保证同一个分区的记录顺序，不同分区的顺序无法保证。通过分区排序和按键(key)分区满足大多数应用的需求。如果需要全局的顺序呢，只能使用一个分区的主题，这个分区只有一个消费者。这意味这同一个分区，如果有2个消费者消费的话，另外一个消费者会”很闲”，也就是无法处理消息。</p><h4 id=主题和日志topics-and-logs>主题和日志(Topics and Logs)</h4><p>所谓的主题是，发布记录的类别或者订阅名称。主题一般是多订阅者的，这意味着可以有0个，1个，多个订阅者等订阅写入的数据。</p><p>Kafka对每一个主题维护一个分区日志，每个分区都是一个有序的，以不可变的记录，也就是不断追加到结构化的提交日志。分区中每个记录都一个连续的id，称为偏移(offset)，唯一标识分区内的记录。这个偏移由消费者控制，所以消费者可以以任何顺序消费消息。</p><p>Kafka集群使用可配置的保留时间，来持久化存储全部已发布的消息，无论是否被客户端消费。</p><p>分区日志的作用是，可以减少日志的大小，单个服务器可以存储下，更多的作用是方便进行扩展。</p><h4 id=分布式distribution>分布式(Distribution)</h4><p>Kafka通过zookeeper实现分区容错性，只需要n/2+1个节点存活，就可以保证较好的容错性。每个分区都在可配置的服务器上进行复制，以便实现容错。</p><h4 id=geo复制geo-replication>GEO复制(Geo-Replication)</h4><p>Kafka采用MirrorMaker实现集群的地理复制功能，可以跨数据中心或者多个云。</p><h4 id=多租户multi-tenancy>多租户(Multi-tenancy)</h4><p>Kafka也支持多租户的配置方案。</p><h4 id=保证guarantees>保证(Guarantees)</h4><p>高级别的Kafka提供以下保证：</p><ol><li>生产者发送到特定主题分区的消息将按照其发送的顺序追加。也就是说，哪一条记录先发送就具有更低的偏移且在日志中出现得更早。</li><li>消费者按照分区日志的顺序查看记录。</li><li>对有N个复制者的主题，最多能容忍N-1个服务器挂掉，而不会丢失任何提交到日志的记录。</li></ol><h4 id=消息系统kafka-as-a-messaging-system>消息系统(Kafka as a Messaging System)</h4><p>Kafka作为消息系统的优势：</p><ol><li>每个主题可以自动进行扩展，可以有多个订阅者。</li><li>比起传统的消息系统，有更好的顺序保证。</li><li>通过分区的概念，提供顺序保证和自动负载均衡，提高并发处理的能力。</li></ol><h4 id=存储系统kafka-as-a-storage-system>存储系统(Kafka as a Storage System)</h4><p>由于kafka较好的存储并且允许客户端控制读取的位置，你可以将其认为是一个高性能，低延迟提交日志存储，用于复制和传播，专用分布式文件系统。</p><h4 id=流处理kafka-for-stream-processing>流处理(Kafka for Stream Processing)</h4><p>Kafka不仅可以读取，写入和存储数据流，还可以实现流的实时处理目的。</p><h3 id=为什么kafka会这么快>为什么Kafka会这么快</h3><p>大多数人，选择Kafka的特性之一就是极佳的性能，为什么Kafka会这么快？</p><h5 id=顺序写入sequential-io>顺序写入/SEQUENTIAL IO</h5><p>Kafka尽量会避免随机磁盘访问，采用了顺序写入的策略。大多数服务器都是采用的SATA硬盘这类机械硬盘，当Kafka收到消息后，会顺序写入到当前的分区文件的末尾，也就是所谓的分区其实就是一个文件。如果所有服务器采用SSD硬盘的话，这个策略的优势提升不大。这个技巧还用在MySQL InnoDB上，运用事务日志把随机IO转成顺序IO。</p><table><thead><tr><th align=left>代价</th><th align=left>顺序IO</th><th align=left>随机IO</th></tr></thead><tbody><tr><td align=left>寻道时间</td><td align=left>较短(3ms)</td><td align=left>较长(15ms)</td></tr><tr><td align=left>旋转延迟</td><td align=left>较短(2ms)</td><td align=left>较大(4ms)</td></tr><tr><td align=left>处理资源</td><td align=left>少</td><td align=left>多</td></tr><tr><td align=left>IOPS(Input/Output Operations Per Second)</td><td align=left>高</td><td align=left>低</td></tr></tbody></table><h5 id=内存映射memory-mapped-files>内存映射(MEMORY MAPPED FILES)</h5><p>将操作系统的内存与磁盘上的文件进行映射，也就是虚拟内存页(Page)，可以像对硬盘一样读写虚拟内存，通过操作系统的策略稍后定时同步到磁盘上，提升数据写入的效率。</p><h5 id=读取数据>读取数据</h5><p>采用了零拷贝技术，实现性能极大提升。所谓的零拷贝技术，就是减少了用户空间与内核空间的文件拷贝，避免CPU操作无效的数据存储拷贝，主要还是通过系统mmap实现。</p><h3 id=参考链接>参考链接</h3><ol><li><a href=https://kafka.apache.org/documentation/#introduction>Kafka Introduction</a></li><li><a href=http://ifeve.com/kafka-intro/>KAFKA官方文档</a></li><li><a href=https://www.kancloud.cn/en1228/kafka/426308>Kafka 官方文档翻译[20171016]</a></li><li><a href=http://ifeve.com/kafka-intro/>KAFKA官方文档 简介</a></li><li><a href=https://blog.newrelic.com/engineering/kafka-best-practices/>20 Best Practices for Working With Apache Kafka at Scale</a></li><li><a href=https://www.slideshare.net/HadoopSummit/apache-kafka-best-practices>Apache Kafka Best Practices</a></li><li><a href=https://www.cnblogs.com/huxi2b/p/6720292.html>Kafka最佳实践 / Kafka Best Practices</a></li><li><a href=https://community.hortonworks.com/articles/80813/kafka-best-practices-1.html>Kafka Best Practices</a></li><li><a href=https://mp.weixin.qq.com/s/pzVS7r3QaQPFwob-fY8b4A>为什么Kafka这么快</a></li><li><a href=http://www.10tiao.com/html/254/201607/2648945468/1.html>为什么Kafka这么快</a></li><li><a href=https://tech.meituan.com/2017/05/19/about-desk-io.html>磁盘I/O那些事</a></li><li><a href=https://blog.csdn.net/asdfsadfasdfsa/article/details/83015488>随机 I/O & 顺序 I/O</a></li><li><a href=https://flashdba.com/2013/04/15/understanding-io-random-vs-sequential/>Understanding I/O: Random vs Sequential</a></li><li><a href=https://blog.csdn.net/shmily_lsl/article/details/81877447>Kafka消费者：从Kafka中读取数据</a></li><li><a href=https://segmentfault.com/a/1190000011989008>Linux下的零拷贝</a></li><li><a href=https://medium.freecodecamp.org/what-makes-apache-kafka-so-fast-a8d4f94ab145>Here’s what makes Apache Kafka so fast</a></li><li><a href=http://searene.me/2017/07/09/Why-is-Kafka-so-fast/>Why Is Kafka So Fast</a></li></ol><p><img src=https://xbc.me/wp-content/uploads/20190131.p1.png alt=img></p></div></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="GeekWho avatar" src=/images/avatar.jpeg class=avatar height=90 width=90></figure><div class=authorbox__header><span class=authorbox__name>关于 GeekWho</span></div><div class=authorbox__description>PHP and Go are the best language in the world.</div></div><div id=gitalk-container></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script><script>const gitalk=new Gitalk({clientID:'13b47a49e0f947bf69e0',clientSecret:'a4f2f9622955ed3993f37d1b82eddab12abdeffe',repo:'xbc.me',owner:'geekwho11',admin:['geekwho11'],id:location.pathname,distractionFreeMode:false});(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('gitalk-container').innerHTML='Gitalk comments not available by default when the website is previewed locally.';return;}
gitalk.render('gitalk-container');})();</script></div><aside class=sidebar><div class="widget-search widget"><form class=widget-search__form role=search method=get action=https://google.com/search><label><input class=widget-search__field type=search placeholder=搜索... name=q aria-label=搜索...></label>
<input class=widget-search__submit type=submit value=Search>
<input type=hidden name=sitesearch value=https://xbc.me></form></div><div class="widget-recent widget"><h4 class=widget__title>近期文章</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/add-gittalk-to-hugo/>为hugo添加gittalk组件</a></li><li class=widget__item><a class=widget__link href=/how-to-create-an-archives-page-with-hugo/>为hugo添加归档页面</a></li><li class=widget__item><a class=widget__link href=/hello-hugo-and-goodbye-wordpress/>你好Hugo，再见WordPress</a></li><li class=widget__item><a class=widget__link href=/build-master-slave-mysql-service/>搭建主从MySQL服务</a></li><li class=widget__item><a class=widget__link href=/git-command-line-development-guide/>Git命令行开发指南</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>分类</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/%E5%AD%A6%E7%BC%96%E7%A8%8B/>学编程</a></li><li class=widget__item><a class=widget__link href=/categories/%E7%A5%9E%E7%A7%98%E6%9E%81%E5%AE%A2/>神秘极客</a></li><li class=widget__item><a class=widget__link href=/categories/%E9%9A%8F%E7%AC%94/>随笔</a></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>标签</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/tags/githubpages/ title=GithubPages>GithubPages</a>
<a class="widget-taglist__link widget__link btn" href=/tags/go/ title=Go>Go</a>
<a class="widget-taglist__link widget__link btn" href=/tags/javascript/ title=JavaScript>JavaScript</a>
<a class="widget-taglist__link widget__link btn" href=/tags/linux/ title=Linux>Linux</a>
<a class="widget-taglist__link widget__link btn" href=/tags/magento/ title=Magento>Magento</a>
<a class="widget-taglist__link widget__link btn" href=/tags/mysql/ title=MySQL>MySQL</a>
<a class="widget-taglist__link widget__link btn" href=/tags/nginx/ title=Nginx>Nginx</a>
<a class="widget-taglist__link widget__link btn" href=/tags/php/ title=PHP>PHP</a>
<a class="widget-taglist__link widget__link btn" href=/tags/ubuntu/ title=Ubuntu>Ubuntu</a>
<a class="widget-taglist__link widget__link btn" href=/tags/unittest/ title=UnitTest>UnitTest</a>
<a class="widget-taglist__link widget__link btn" href=/tags/wordpress/ title=WordPress>WordPress</a>
<a class="widget-taglist__link widget__link btn" href=/tags/%E5%89%8D%E7%AB%AF/ title=前端>前端</a>
<a class="widget-taglist__link widget__link btn" href=/tags/%E5%90%8E%E7%AB%AF/ title=后端>后端</a>
<a class="widget-taglist__link widget__link btn" href=/tags/%E5%B8%B8%E8%A7%81%E7%AE%97%E6%B3%95/ title=常见算法>常见算法</a>
<a class="widget-taglist__link widget__link btn" href=/tags/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/ title=年终总结>年终总结</a>
<a class="widget-taglist__link widget__link btn" href=/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/ title=数据结构>数据结构</a></div></div><div class="widget-social widget"><h4 class="widget-social__title widget__title">社交</h4><div class="widget-social__content widget__content"><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=GitHub rel="noopener noreferrer" href=https://github.com/geekwho11 target=_blank><svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0C85.9.0.0 85.8.0 191.7c0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2.0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8.0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7.0.0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4.0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5.0 25.6-.2 46.3-.2 52.6.0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg><span>GitHub</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=Email href=mailto:geekwho@xbc.me><svg class="widget-social__link-icon icon icon-mail" width="24" height="24" viewBox="0 0 416 288"><path d="m0 16v256 16h16 384 16v-16V16 0h-16H16 0zm347 16-139 92.5L69 32zM199 157.5l9 5.5 9-5.5L384 46v210H32V46z"/></svg><span>geekwho@xbc.me</span></a></div></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2020 神秘极客.
<span class=footer__copyright-credits>基于 <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> 引擎和 <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a>主題</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>